<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CSV Map with Legend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster CSS & JS (for clustering and spiderfying) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    #map { height: 90vh; width: 100%; }
    .legend { background: white; padding: 10px; line-height: 1.5em; }
    .legend input { vertical-align: middle; }
    .legend label { margin-left: 5px; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="legend" class="legend"></div>

<script>
  // Set initial map view to the coordinates (41.2194833, -106.2815294)
  const map = L.map('map').setView([41.2194833, -106.2815294], 20);

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
  }).addTo(map);

  const colors = {};

  // Function to generate random color for categories
  function getColor(category) {
    if (!colors[category]) {
      colors[category] = '#' + Math.floor(Math.random() * 16777215).toString(16);
    }
    return colors[category];
  }

  // Function to add legend
  function addLegend(categories) {
    const legend = document.getElementById('legend');
    legend.innerHTML = '<b>Toggle Categories:</b><br>';
    categories.forEach(category => {
      const color = getColor(category);
      legend.innerHTML += `
        <div>
          <input type="checkbox" id="${category}" checked onchange="toggleLayer('${category}')">
          <span style="color:${color};">&#9679;</span>
          <label for="${category}">${category}</label>
        </div>
      `;
    });
  }

  // Function to toggle visibility of layers
  function toggleLayer(category) {
    if (layers[category]) {
      const layerGroup = layers[category];
      if (map.hasLayer(layerGroup)) {
        map.removeLayer(layerGroup);
      } else {
        map.addLayer(layerGroup);
      }
    }
  }

  const csvUrl = 'https://raw.githubusercontent.com/Recca2831/Dave-Project/refs/heads/main/wy-geo-db-polished.csv';

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;
      const categories = new Set();
      const markerClusters = L.markerClusterGroup(); // Create a marker cluster group

      data.forEach(row => {
        const lat = parseFloat(row.Latitude);
        const lon = parseFloat(row.Longitude);
        const category = row.Cd_ppm_ICP61 || "Uncategorized";

        if (isNaN(lat) || isNaN(lon)) return;

        categories.add(category);

        let popupContent = '<strong>Details:</strong><br>';
        for (const key in row) {
          if (row.hasOwnProperty(key)) {
            const value = row[key] || 'N/A';
            if (key.toLowerCase() === 'website') {
              popupContent += `<b>${key}:</b> <a href="${value}" target="_blank">${value}</a><br>`;
            } else {
              popupContent += `<b>${key}:</b> ${value}<br>`;
            }
          }
        }

        // Create a marker and bind a popup
        const marker = L.circleMarker([lat, lon], {
          radius: 6,
          color: getColor(category),
          fillOpacity: 0.8
        }).bindPopup(popupContent);

        // Add marker to the marker cluster group (This handles clustering and spiderfying)
        markerClusters.addLayer(marker);
      });

      // Add all markers to the map using the marker cluster group (which handles clustering and spiderfying)
      map.addLayer(markerClusters);

      // Add the legend
      addLegend(Array.from(categories));

      // Fit map to bounds of all markers
      map.fitBounds(markerClusters.getBounds());
    }
  });
</script>

</body>
</html>
